<head>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.11.7/lib/p5.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    button {
      padding: 2rem;
      font-size: 4rem;
    }
    #viewfinder {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 75%;
      z-index: 100;
    }
  </style>
</head>

<body>
  <canvas id="viewfinder"></canvas>
</body>

<script>

var button;
var capture;
var capturedImage;
var capturedLocation;

function geoLocate() {
  function success(position) {
    const latitude = position.coords.latitude;
    const longitude = position.coords.longitude;
    capturedLocation = { latitude: latitude, longitude: longitude };
  }

  function error() {
    capturedLocation = { latitude: null, longitude: null};
  }

  if (!navigator.geolocation) {
    alert("Geolocation is not supported by your browser");
  } else {
    navigator.geolocation.getCurrentPosition(success, error);
  }
}

function setup() {

  geoLocate();

  createCanvas(windowWidth, .75*windowHeight);

  button = createButton("Capture");
  button.mousePressed(capturePhoto);
  button.position(0, .85*windowHeight);
  button.center("horizontal");

  capturedImage = createImage(768, 1024);

  var constraints = {
    audio: false,
    video: {
      mandatory: {
        minWidth: 1024,
        minHeight: 768
      },
      facingMode: {
        exact: "environment"
      }
    }    
  };
  capture = createCapture(constraints);
  capture.hide();
}


function draw() {
 background(200);
 image(capture, 0, 0, windowWidth, .75*windowHeight); 
}

function submit() {
  const data = {
    latitude: capturedLocation.latitude,
    longitude: capturedLocation.longitude,
    image: capturedImage.canvas.toDataURL()
  }

  const form = document.createElement('form');
  form.method = 'POST';
  form.style.display = 'none';
  document.body.appendChild(form);
  for (const key in data) {
    if (data.hasOwnProperty(key)) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = key;
      input.value = data[key];
      form.appendChild(input);
    }
  }
  form.submit();
}

function capturePhoto() {
  button.attribute('disabled', '');
  capturedImage = capture.get(0, 0, 768, 1024);
  geoLocate();
  setTimeout(submit, 250);
}

setup();

</script>
